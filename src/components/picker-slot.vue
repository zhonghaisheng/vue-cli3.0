<template>
  <div class="nut-picker-list">
    <div class="nut-picker-roller" ref="roller">
      <div
        class="nut-picker-roller-item"
        :class="{'nut-picker-roller-item-hidden': isHidden(index + 1)}"
        v-for="(item,index) in listData"
        :style="setRollerStyle(index + 1)"
        :key="index"
      >{{item}}</div>
    </div>
    <div class="nut-picker-content">
      <div class="nut-picker-list-panel" ref="list">
        <div class="nut-picker-item" v-for="(item,index) in listData" :key="index">{{item}}</div>
      </div>
    </div>
    <div class="nut-picker-mask"></div>
    <div class="nut-picker-indicator"></div>
  </div>
</template>
<script>
export default {
  name: 'nut-picker-slot',
  props: {
    listData: {
      type: Array,
      required: true
    },
    defaultValue: {
      type: String
    },
    keyIndex: {
      type: Number,
      default: 0
    },
    isUpdate: {
      type: Boolean,
      default: false
    },
    isCity:{
      type: Boolean,
      default: false
    },
    isArea:{
      type: Boolean,
      default: false
    },
    isDate:{
      type: Boolean,
      default: false
    },
    isDateindex:{
      type: Number,
      default: 27
    }
  },
  data () {
    return {
      touchParams: {
        startY: 0,
        endY: 0,
        startTime: 0,
        endTime: 0
      },
      currIndex: 1,
      transformY: 0,
      scrollDistance: 0, // 滚动距离
      lineSpacing: 36,
      rotation: 20,
      timer: null
    }
  },
  watch: {
    isUpdate: function () {
      this.transformY = 0
      this.modifyStatus()
    },
    defaultValue: function () {
      this.transformY = 0
      this.modifyStatus()
    },
    isCity:function(){
      //单独刷新市列表
      this.transformY = 0
      this.setMove(0)
    },
    isArea:function(){
      //单独刷新区列表
      this.transformY = 0
      this.setMove(0)
    },
    isDate:function(){
      //单独刷新日列表
      this.transformY = 0
      this.setMove(-this.isDateindex * this.lineSpacing)
    }
  },
  methods: {
    updateTransform (value) {
      if (value) {
        this.transformY = 0
        this.timer = setTimeout(() => {
          this.modifyStatus(null, value)
        }, 10)
      }
    },

    setRollerStyle (index) {
      return `transform: rotate3d(1, 0, 0, ${-this.rotation *
        index}deg) translate3d(0px, 0px, 104px)`
    },

    isHidden (index) {
      if (index >= this.currIndex + 8 || index <= this.currIndex - 8) {
        return true
      } else {
        return false
      }
    },

    setTransform (translateY = 0, type, time = 1000, deg) {
      if (type === 'end') {
        this.$refs.list.style.webkitTransition = `transform ${time}ms cubic-bezier(0.19, 1, 0.22, 1)`
        this.$refs.roller.style.webkitTransition = `transform ${time}ms cubic-bezier(0.19, 1, 0.22, 1)`
      } else {
        this.$refs.list.style.webkitTransition = ''
        this.$refs.roller.style.webkitTransition = ''
      }
      this.$refs.list.style.webkitTransform = `translate3d(0, ${translateY}px, 0)`
      this.$refs.roller.style.webkitTransform = `rotate3d(1, 0, 0, ${deg})`
      this.scrollDistance = translateY
    },

    setMove (move, type, time) {
      let updateMove = move + this.transformY
      // 设置极值，让用户滚动的时候不至于手不送可以一直滚动
      let maxMove = this.lineSpacing * 2
      let minMove = -this.lineSpacing * this.listData.length - this.lineSpacing
      if (updateMove > maxMove) updateMove = maxMove
      if (updateMove < minMove) updateMove = minMove
      if (type === 'end') {
        // 限定滚动距离
        if (updateMove > 0) {
          updateMove = 0
        }
        if (updateMove < -(this.listData.length - 1) * this.lineSpacing) {
          updateMove = -(this.listData.length - 1) * this.lineSpacing
        }

        // 设置滚动距离为lineSpacing的倍数值
        let endMove =
          Math.round(updateMove / this.lineSpacing) * this.lineSpacing
        let deg = `${(Math.abs(Math.round(endMove / this.lineSpacing)) + 1) *
          this.rotation}deg`
        this.setTransform(endMove, type, time, deg)
        this.timer = setTimeout(() => {
          this.setChooseValue(endMove)
        }, time / 2)

        this.currIndex = Math.abs(Math.round(endMove / this.lineSpacing)) + 1
      } else {
        let deg = '0deg'
        // 上拉减小 下滑增大  默认为 0 ，大于 0 说明超出范围
        if (updateMove < 0) {
          deg = `${(Math.abs(updateMove / this.lineSpacing) + 1) *
            this.rotation}deg`
        } else {
          deg = `${(-updateMove / this.lineSpacing + 1) * this.rotation}deg`
        }
        this.setTransform(updateMove, null, null, deg)
        this.currIndex =
          Math.abs(Math.round(updateMove / this.lineSpacing)) + 1
      }
    },

    setChooseValue (move) {
      this.$emit('chooseItem', this.listData[Math.round(-move / this.lineSpacing)], this.keyIndex)
    },

    touchStart (event) {
      event.preventDefault()

      let changedTouches = event.changedTouches[0]
      this.touchParams.startY = changedTouches.pageY
      this.touchParams.startTime = event.timestamp || Date.now()
      this.transformY = this.scrollDistance
    },

    touchMove (event) {
      event.preventDefault()

      let changedTouches = event.changedTouches[0]
      this.touchParams.lastY = changedTouches.pageY
      this.touchParams.lastTime = event.timestamp || Date.now()

      let move = this.touchParams.lastY - this.touchParams.startY
      this.setMove(move)
    },

    touchEnd (event) {
      event.preventDefault()

      let changedTouches = event.changedTouches[0]
      this.touchParams.lastY = changedTouches.pageY
      this.touchParams.lastTime = event.timestamp || Date.now()
      let move = this.touchParams.lastY - this.touchParams.startY

      let moveTime = this.touchParams.lastTime - this.touchParams.startTime
      if (moveTime <= 300) {
        move = move * 2
        moveTime = moveTime + 1000
        this.setMove(move, 'end', moveTime)
      } else {
        this.setMove(move, 'end')
      }
    },
    // 修改状态
    modifyStatus (type, defaultValue) {
      defaultValue = defaultValue || this.defaultValue
      let index = this.listData.indexOf(defaultValue)
      this.currIndex = index === -1 ? 1 : index + 1
      let move = index === -1 ? 0 : index * this.lineSpacing
      type && this.setChooseValue(-move)
      this.setMove(-move)
    }
  },

  mounted () {
    this.$nextTick(() => {
      this.modifyStatus(true)
      // 监听
      this.$el.addEventListener('touchstart', this.touchStart)
      this.$el.addEventListener('touchmove', this.touchMove)
      this.$el.addEventListener('touchend', this.touchEnd)
    })
  },
  beforeDestroy () {
    this.$el.removeEventListener('touchstart', this.touchStart)
    this.$el.removeEventListener('touchmove', this.touchMove)
    this.$el.removeEventListener('touchend', this.touchEnd)
    clearTimeout(this.timer)
  }
}
</script>
<style lang="less" scoped>
.container{
  display:flex;
}
.nut-picker{
    background-color: #FFF;
    width: 100%;
}
.nut-picker-control{
    display: flex;
    height: 40px;
    border-bottom: 1px solid #f30;
    text-align: center;
    line-height: 40px;
    font-size: 14px;
    .nut-picker-cancel-btn,
    .nut-picker-confirm-btn{
        width: 60px;
        color: #f30;
    }
    .nut-picker-title{
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
}

.nut-picker-panel{
    height: 252px;
    display: flex;
}
.nut-picker-list{
    flex: 1;
    position: relative;
    height: 252px;
    overflow: hidden;
    text-align: center;
    .nut-picker-mask{
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        //background-image: linear-gradient(180deg,hsla(0,0%,100%,.9),hsla(0,0%,100%,.6)),linear-gradient(0deg,hsla(0,0%,100%,.9),hsla(0,0%,100%,.6));
        background-position: top, bottom;
        background-size: 100% 108px;
        background-repeat: no-repeat;
        z-index: 3;
    }
    .nut-picker-indicator{
        position: absolute;
        top: 108px;
        width: 100%;
        height: 34px;
        border-top: 1px solid #f30;
        border-bottom: 1px solid #f30;
        z-index: 3;
    }
    
    .nut-picker-content, .nut-picker-roller{
        position: absolute;
        top: 108px;
        width: 100%;
        height: 36px;
    }
    .nut-picker-content{
        background: #FFF;
        z-index: 2;
        overflow: hidden;
    }
    .nut-picker-item, .nut-picker-roller-item{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 36px;
        color: #000;
        font-size: 15px;
        text-align: center;
    }
    .nut-picker-item{
        font-size: 15px;
        background: #FFF;
    }
    .nut-picker-roller{
        z-index: 1;
        transform-style: preserve-3d;
        .nut-picker-roller-item{
            backface-visibility: hidden;
            position: absolute;
            top: 0;
            width: 100%;
            color: #000;
        }
        .nut-picker-roller-item-hidden {
            visibility: hidden;
            opacity: 0;
        }
    }
}
</style>